"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}();function getResetValue(e,t){return _xeUtils.default.isString(e)?t="":_xeUtils.default.isArray(e)?t=[]:_xeUtils.default.isBoolean(e)&&(t=!1),t}function renderItems(t,e){var r=e.items;return r?r.map(function(e){return t("vxe-form-item",{props:e})}):[]}var _default2={name:"VxeForm",props:{loading:Boolean,data:Object,size:String,span:[String,Number],align:String,titleAlign:String,titleWidth:[String,Number],titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},items:Array,rules:Object},data:function(){return{collapseAll:!0,invalids:[]}},provide:function(){return{$vxeform:this}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize}},render:function(e){var t,r=this.$slots,i=this.titleColon,n=this.loading,a=this.vSize;return e("form",{class:["vxe-form","vxe-row",(t={},_defineProperty(t,"size--".concat(a),a),_defineProperty(t,"is--colon",i),_defineProperty(t,"is--loading",n),t)],on:{submit:this.submitEvent,reset:this.resetEvent}},[].concat(r.default||renderItems(e,this)).concat([e("div",{class:["vxe-loading",{"is--visible":n}]},[e("div",{class:"vxe-loading--spinner"})])]))},methods:{toggleCollapse:function(){return this.collapseAll=!this.collapseAll,this.$nextTick()},submitEvent:function(t){var r=this;t.preventDefault(),this.beginValidate().then(function(){r.$emit("submit",{data:r.data,$form:r,$event:t},t)}).catch(function(e){r.$emit("submit-invalid",{data:r.data,errMap:e,$form:r,$event:t},t)})},resetEvent:function(e){var a=this;e.preventDefault();var l=this.data;l&&this.$children.forEach(function(e){var t=e.field,r=e.resetValue,i=e.itemRender;if(t){_xeUtils.default.set(l,t,null===r?getResetValue(_xeUtils.default.get(l,t),r):r);var n=i?_vXETable.default.renderer.get(i.name):null;n&&n.itemResetMethod&&n.itemResetMethod({data:l,property:t,$form:a})}}),this.clearValidate(),this.$emit("reset",{data:l,$form:this,$event:e},e)},clearValidate:function(t){return t?_xeUtils.default.remove(this.invalids,function(e){return e.property===t}):this.invalids=[],this.$nextTick()},validate:function(e){return this.beginValidate(e)},beginValidate:function(t,e){var n=this,r=this.data,i=this.rules,a={},l=[],s=[];return this.clearValidate(),r&&i?(this.$children.forEach(function(e){var i=e.field;i&&s.push(new Promise(function(e,r){n.validItemRules(t||"all",i).then(e).catch(function(e){var t={rule:e.rule,rules:e.rules,property:i};return a[i]||(a[i]=[]),a[i].push(t),l.push(i),n.invalids.push(t),r(t)})}))}),Promise.all(s).then(function(){e&&e()}).catch(function(){return e&&e(a),n.$nextTick(function(){n.handleFocus(l)}),Promise.reject(a)})):(e&&e(),Promise.resolve())},validItemRules:function(n,a,e){var t=this.data,r=this.rules,l=[],s=[];if(a&&r){var u=_xeUtils.default.get(r,a);if(u){var o=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(t,a):e;u.forEach(function(i){s.push(new Promise(function(r){if("all"!==n&&i.trigger&&n!==i.trigger)r();else if(_xeUtils.default.isFunction(i.validator))i.validator(i,o,function(e){if(_xeUtils.default.isError(e)){var t={type:"custom",trigger:i.trigger,message:e.message,rule:new Rule(i)};l.push(new Rule(t))}return r()},{rules:u,property:a});else{var e="number"===i.type,t=e?_xeUtils.default.toNumber(o):_xeUtils.default.getSize(o);null==o||""===o?i.required&&l.push(new Rule(i)):(e&&isNaN(o)||!isNaN(i.min)&&t<parseFloat(i.min)||!isNaN(i.max)&&t>parseFloat(i.max)||i.pattern&&!(i.pattern.test?i.pattern:new RegExp(i.pattern)).test(o))&&l.push(new Rule(i)),r()}}))})}}return Promise.all(s).then(function(){if(l.length){var e={rules:l,rule:l[0]};return Promise.reject(e)}})},handleFocus:function(e){var s=this.$children;e.some(function(t){var e=s.find(function(e){return e.field===t});if(e&&e.itemRender){var r,i=e.$el,n=e.itemRender,a=_vXETable.default.renderer.get(n.name);if(n.autofocus&&(r=i.querySelector(n.autofocus)),!r&&a&&a.autofocus&&(r=i.querySelector(a.autofocus)),r){if(r.focus(),_tools.DomTools.browse.msie){var l=r.createTextRange();l.collapse(!1),l.select()}return!0}}})},updateStatus:function(e,t){var n=this,a=e.property;a&&this.validItemRules("change",a,t).then(function(){n.clearValidate(a)}).catch(function(e){var t=e.rule,r=e.rules,i=n.invalids.find(function(e){return e.property===a});i?(i.rule=t,i.rules=r):n.invalids.push({rule:t,rules:r,property:a})})}}};exports.default=_default2;