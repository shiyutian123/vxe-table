"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var l=Object.prototype.toString.call(e).slice(8,-1);return"Object"===l&&e.constructor&&(l=e.constructor.name),"Map"===l||"Set"===l?Array.from(l):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var l=0,r=new Array(t);l<t;l++)r[l]=e[l];return r}function _defineProperty(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function countTreeExpand(e,t){var l=t.$table,r=e[l.treeOpts.children],o=1;if(l.isTreeExpandByRow(e))for(var n=0;n<r.length;n++)o+=countTreeExpand(r[n],t);return o}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t){var l=e.$table,r=e.$rowIndex,o=1;return r&&(o=countTreeExpand(t[r-1],e)),l.rowHeight*o-(r?1:12-getOffsetSize(l))}function renderLine(e,t,l,r,o,n){var i=n.column,s=l.treeOpts,a=l.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(l,n,e):i.treeNode&&a&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,o),"px"),left:"".concat(r*s.indent+(r?2-getOffsetSize(l):0)+16,"px")}})])]:[]}function renderBorder(e,t){return e("div",{class:"vxe-table-".concat(t,"ed-borders"),ref:"".concat(t,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(t,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(t,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(t,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(t,"Left")})])}function renderColumn(e,t,l,r,o,n,i,s,a,c,d,u,p,f,y,v){var x,m,b=l._e,g=l.$listeners,h=l.tableData,w=l.height,_=l.columnKey,T=l.overflowX,$=l.scrollXLoad,S=l.scrollYLoad,C=l.highlightCurrentRow,O=l.showOverflow,L=l.align,I=l.currentColumn,k=l.cellClassName,E=l.cellStyle,R=l.spanMethod,q=l.radioOpts,A=l.checkboxOpts,B=l.expandOpts,U=l.treeOpts,P=l.mouseConfig,D=l.mouseOpts,H=l.editConfig,M=l.editOpts,N=l.editRules,X=l.validOpts,z=l.editStore,j=l.validStore,W=u.editRender,Y=u.align,F=u.showOverflow,K=u.className,G=u.treeNode,V=z.actived,J=P&&D.selected,Q=P&&(D.range||D.checked),Z=i?u.fixed!==i:u.fixed&&T,ee=_xeUtils.default.isUndefined(F)||_xeUtils.default.isNull(F)?O:F,te="ellipsis"===ee,le="title"===ee,re=!0===ee||"tooltip"===ee,oe=le||re||te,ne={},ie=Y||L,se=j.row===a&&j.column===u,ae=N&&("default"===X.message?w||1<h.length:"inline"===X.message),ce={"data-colid":u.id},de=W&&H&&"dblclick"===M.trigger,ue={$table:l,$seq:r,seq:o,rowid:n,row:a,rowIndex:c,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:v};if(!$&&!S||oe||(te=oe=!0),(le||re||g["cell-mouseenter"])&&(ne.mouseenter=function(e){isOperateMouse(l)||(le?_tools.DomTools.updateCellTitle(e):re&&l.triggerTooltipEvent(e,ue),_tools.UtilTools.emitEvent(l,"cell-mouseenter",[{$table:l,$seq:r,seq:o,rowid:n,row:a,rowIndex:c,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:v,$event:e},e]))}),(re||g["cell-mouseleave"])&&(ne.mouseleave=function(e){isOperateMouse(l)||(re&&l.handleTargetLeaveEvent(e),_tools.UtilTools.emitEvent(l,"cell-mouseleave",[{$table:l,$seq:r,seq:o,rowid:n,row:a,rowIndex:c,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:v,$event:e},e]))}),(A.range||Q||J)&&(ne.mousedown=function(e){l.triggerCellMousedownEvent(e,ue)}),(C||g["cell-click"]||Q||W&&H||"row"===B.trigger||"cell"===B.trigger||"row"===q.trigger||"radio"===u.type&&"cell"===q.trigger||"row"===A.trigger||("checkbox"===u.type||"selection"===u.type)&&"cell"===A.trigger||"row"===U.trigger||u.treeNode&&"cell"===U.trigger)&&(ne.click=function(e){l.triggerCellClickEvent(e,ue)}),(de||g["cell-dblclick"])&&(ne.dblclick=function(e){l.triggerCellDBLClickEvent(e,ue)}),R){var pe=R(ue)||{},fe=pe.rowspan,ye=void 0===fe?1:fe,ve=pe.colspan,xe=void 0===ve?1:ve;if(!ye||!xe)return null;ce.rowspan=ye,ce.colspan=xe}!Z&&W&&H&&M.showStatus&&(m=l.isUpdateByRow(a,u.property));var me="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(x={},_defineProperty(x,"col--".concat(ie),ie),_defineProperty(x,"col--".concat(me),me),_defineProperty(x,"col--last",f===y.length-1),_defineProperty(x,"col--tree-node",G),_defineProperty(x,"col--edit",!!W),_defineProperty(x,"col--ellipsis",oe),_defineProperty(x,"edit--visible",W&&"visible"===W.type),_defineProperty(x,"fixed--hidden",Z),_defineProperty(x,"col--dirty",m),_defineProperty(x,"col--actived",H&&W&&V.row===a&&(V.column===u||"row"===M.mode)),_defineProperty(x,"col--valid-error",se),_defineProperty(x,"col--current",I===u),x),_tools.UtilTools.getClass(K,ue),_tools.UtilTools.getClass(k,ue)],key:_?u.id:p,attrs:ce,style:E?_xeUtils.default.isFunction(E)?E(ue):E:null,on:ne},O&&Z?[e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":re,"c--ellipsis":te}]})]:renderLine(e,t,l,s,v,ue).concat([e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":re,"c--ellipsis":te}],attrs:{title:le?_tools.UtilTools.getCellLabel(a,u,ue):null}},u.renderCell(e,ue)),ae?se?e("div",{class:"vxe-cell--valid",style:j.rule&&j.rule.maxWidth?{width:"".concat(j.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},j.content)]):b():null]))}function renderRows(u,p,f,y,v,x,m,b){var g=f.stripe,h=f.rowKey,w=f.highlightHoverRow,_=f.rowClassName,T=f.rowStyle,$=f.showOverflow,S=f.treeConfig,C=f.treeOpts,O=f.treeExpandeds,L=f.scrollYLoad,I=f.scrollYStore,k=f.editStore,E=f.rowExpandeds,R=f.radioOpts,q=f.checkboxOpts,A=f.expandColumn,B=f.getColumnIndex,U=[];return m.forEach(function(r,o){var e={},n=o,i=n+1;L&&(i+=I.startIndex),n=f.getRowIndex(r),w&&(e.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:r,rowIndex:n})},e.mouseleave=function(){isOperateMouse(f)||f.clearHoverRow()});var s=_tools.UtilTools.getRowid(f,r);if(U.push(u("tr",{class:["vxe-body--row",{"row--stripe":g&&(f._getRowIndex(r)+1)%2==0,"is--new":-1<k.insertList.indexOf(r),"row--radio":R.highlight&&f.selectRow===r,"row--cheched":q.highlight&&f.isCheckedByCheckboxRow(r)},_?_xeUtils.default.isFunction(_)?_({$table:f,$seq:y,seq:i,rowid:s,fixedType:x,rowLevel:v,row:r,rowIndex:n,$rowIndex:o}):_:""],attrs:{"data-rowid":s},style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:y,seq:i,rowid:s,fixedType:x,rowLevel:v,row:r,rowIndex:n,$rowIndex:o}):T:null,key:h||S?s:o,on:e},b.map(function(e,t){var l=B(e);return renderColumn(u,p,f,y,i,s,x,v,r,n,o,e,l,t,b,m)}))),E.length&&-1<E.indexOf(r)){var t,l=B(A);if(S&&(t={paddingLeft:"".concat(v*C.indent+30,"px")}),A){var a=A.showOverflow,c=_xeUtils.default.isUndefined(a)||_xeUtils.default.isNull(a)?$:a;U.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:y,seq:i,rowid:s,fixedType:x,rowLevel:v,row:r,rowIndex:n,$rowIndex:o,isExpanded:!0}):T:null,on:e},[u("td",{class:["vxe-body--expanded-column",{"fixed--hidden":x,"col--ellipsis":c}],attrs:{colspan:b.length}},[u("div",{class:"vxe-body--expanded-cell",style:t},[A.renderData(u,{$table:f,seq:i,rowid:s,row:r,rowIndex:n,column:A,columnIndex:l,fixed:x,level:v})])])]))}}if(S&&O.length){var d=r[C.children];d&&d.length&&-1<O.indexOf(r)&&U.push.apply(U,_toConsumableArray(renderRows(u,p,f,y?"".concat(y,".").concat(i):"".concat(i),v+1,x,d,b)))}}),U}function syncBodyScroll(e,t,l){(t||l)&&(t&&(t.onscroll=null,t.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){t&&(t.onscroll=t._onscroll),l&&(l.onscroll=l._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,t=this.$el,l=this.$refs,r=this.fixedType,o=e.elemStore,n="".concat(r||"main","-body-");o["".concat(n,"wrapper")]=t,o["".concat(n,"table")]=l.table,o["".concat(n,"colgroup")]=l.colgroup,o["".concat(n,"list")]=l.tbody,o["".concat(n,"xSpace")]=l.xSpace,o["".concat(n,"ySpace")]=l.ySpace,o["".concat(n,"emptyBlock")]=l.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e,t=this._e,r=this.$parent,o=this.fixedColumn,n=this.fixedType,i=r.$scopedSlots,s=r.id,a=r.tableData,c=r.tableColumn,d=r.showOverflow,u=r.spanMethod,p=r.scrollXLoad,f=r.mouseConfig,y=r.mouseOpts,v=r.emptyRender,x=r.emptyOpts,m=r.keyboardConfig,b=void 0===m?{}:m,g=f&&(y.range||y.checked);if(u||(n&&d?c=o:p&&n&&(c=o)),i.empty)e=i.empty.call(this,{$table:this},l);else{var h=v?_vXETable.default.renderer.get(x.name):null;e=h&&h.renderEmpty?h.renderEmpty.call(this,l,x,{$table:this},{$table:this}):_conf.default.i18n("vxe.table.emptyText")}return l("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?t():l("div",{class:"vxe-body--x-space",ref:"xSpace"}),l("div",{class:"vxe-body--y-space",ref:"ySpace"}),l("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[l("colgroup",{ref:"colgroup"},c.map(function(e,t){return l("col",{attrs:{name:e.id},key:t})})),l("tbody",{ref:"tbody"},renderRows(l,this,r,"",0,n,a,c))]),n||!g&&!b.isCut?null:l("div",{class:"vxe-table--borders"},[g?renderBorder(l,"check"):null,b.isCut?renderBorder(l,"copy"):null]),n?null:l("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[l("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var t=this.$parent,l=this.fixedType,r=t.$refs,o=t.highlightHoverRow,n=t.scrollXLoad,i=t.scrollYLoad,s=t.lastScrollTop,a=t.lastScrollLeft,c=r.tableHeader,d=r.tableBody,u=r.leftBody,p=r.rightBody,f=r.tableFooter,y=c?c.$el:null,v=f?f.$el:null,x=d.$el,m=u?u.$el:null,b=p?p.$el:null,g=x.scrollTop,h=x.scrollLeft,w=h!==a,_=g!==s;t.lastScrollTop=g,t.lastScrollLeft=h,t.lastScrollTime=Date.now(),o&&t.clearHoverRow(),m&&"left"===l?syncBodyScroll(g=m.scrollTop,x,b):b&&"right"===l?syncBodyScroll(g=b.scrollTop,x,m):(w&&(y&&(y.scrollLeft=x.scrollLeft),v&&(v.scrollLeft=x.scrollLeft)),(m||b)&&(t.checkScrolling(),_&&syncBodyScroll(g,m,b))),n&&w&&(t.triggerScrollXEvent(e),y&&h+x.clientWidth>=x.scrollWidth-80&&this.$nextTick(function(){x.scrollLeft!==y.scrollLeft&&(y.scrollLeft=x.scrollLeft)})),i&&_&&t.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(t,"scroll",[{type:"body",fixed:l,scrollTop:g,scrollLeft:h,isX:w,isY:_,$table:t,$event:e},e])}}};exports.default=_default;