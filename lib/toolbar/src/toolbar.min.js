"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function renderBtns(h,f){var d=f._e,t=f.$scopedSlots,v=f.$xegrid,m=f.$xetable,e=f.buttons,o=void 0===e?[]:e;return t.buttons?t.buttons.call(f,{$grid:v,$table:m},h):o.map(function(e){var t=e.name,o=e.visible,i=e.icon,s=e.type,n=e.status,r=e.disabled,l=e.loading,a=e.dropdowns,c=e.buttonRender,u=c?_vXETable.default.renderer.get(c.name):null;return!1===o?d():u&&u.renderButton?h("span",{class:"vxe-button--item"},u.renderButton.call(f,h,c,{$grid:v,$table:m,button:e},{$grid:v,$table:m})):h("vxe-button",{on:{click:function(t){return f.btnEvent(t,e)}},props:{icon:i,type:s,status:n,disabled:r,loading:l},scopedSlots:a&&a.length?{default:function(){return _tools.UtilTools.getFuncText(t)},dropdowns:function(){return a.map(function(e){return!1===e.visible?d():h("vxe-button",{on:{click:function(t){return f.btnEvent(t,e)}},props:{icon:e.icon,type:e.type,disabled:e.disabled,loading:e.loading}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(t))})}function renderRightTools(t,e){var o=e.$scopedSlots,i=e.$xegrid,s=e.$xetable;return o.tools?o.tools.call(e,{$grid:i,$table:s},t):[]}var _default2={name:"VxeToolbar",props:{id:String,loading:Boolean,resizable:[Boolean,Object],refresh:[Boolean,Object],import:[Boolean,Object],export:[Boolean,Object],zoom:[Boolean,Object],setting:[Boolean,Object],custom:[Boolean,Object],buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},perfect:{type:Boolean,default:function(){return _conf.default.toolbar.perfect}},size:String},inject:{$xegrid:{default:null}},data:function(){return{$xetable:null,isRefresh:!1,tableFullColumn:[],customStore:{isAll:!1,isIndeterminate:!1,visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},importOpts:function(){return Object.assign({},_conf.default.toolbar.import,this.import)},exportOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},zoomOpts:function(){return Object.assign({},_conf.default.toolbar.zoom,this.zoom)},customOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_VISIBLE"},_conf.default.toolbar.custom||_conf.default.toolbar.setting,this.custom||this.setting)}},created:function(){var e=this,t=this.customOpts,o=this.refresh,i=this.resizable,s=this.custom,n=this.setting,r=this.id,l=this.refreshOpts;if(t.storage&&!r)return _tools.UtilTools.error("vxe.error.toolbarId");n&&_tools.UtilTools.warn("vxe.error.delProp",["setting","custom"]),_vXETable.default._export||!this.export&&!this.import||_tools.UtilTools.error("vxe.error.reqModule",["Export"]),this.$nextTick(function(){e.updateConf();var t=e.$xegrid||e.$xetable;if(!o||e.$xegrid||l.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"]),t)t.connect({toolbar:e});else if(i||s||n)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));e.restoreCustomStorage()}),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(s){var t,n=this,e=this.$xegrid,o=this.perfect,i=this.loading,r=this.customStore,l=this.importOpts,a=this.exportOpts,c=this.refresh,u=this.refreshOpts,h=this.zoom,f=this.zoomOpts,d=this.custom,v=this.setting,m=this.customOpts,b=this.vSize,p=this.tableFullColumn,x={},g={};return(d||v)&&("manual"===m.trigger||("hover"===m.trigger?(x.mouseenter=this.handleMouseenterSettingEvent,x.mouseleave=this.handleMouseleaveSettingEvent,g.mouseenter=this.handleWrapperMouseenterEvent,g.mouseleave=this.handleWrapperMouseleaveEvent):x.click=this.handleClickSettingEvent)),s("div",{class:["vxe-toolbar",(t={},_defineProperty(t,"size--".concat(b),b),_defineProperty(t,"is--perfect",o),_defineProperty(t,"is--loading",i),t)]},[s("div",{class:"vxe-button--wrapper"},renderBtns(s,this)),s("div",{class:"vxe-tools--wrapper"},renderRightTools(s,this)),s("div",{class:"vxe-tools--operate"},[this.import?s("div",{class:"vxe-tools--operate-btn vxe-tools--operate-import-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.import")},on:{click:this.importEvent}},[s("i",{class:l.icon||_conf.default.icon.import})]):null,this.export?s("div",{class:"vxe-tools--operate-btn vxe-tools--operate-export-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.export")},on:{click:this.exportEvent}},[s("i",{class:a.icon||_conf.default.icon.export})]):null,c?s("div",{class:"vxe-tools--operate-btn vxe-tools--operate-refresh-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.refresh")},on:{click:this.refreshEvent}},[s("i",{class:this.isRefresh?u.iconLoading||_conf.default.icon.refreshLoading:u.icon||_conf.default.icon.refresh})]):null,h&&e?s("div",{class:"vxe-tools--operate-btn vxe-tools--operate-zoom-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.zoom".concat(e.isMaximized()?"Out":"In"))},on:{click:this.triggerZoomEvent}},[s("i",{class:e.isMaximized()?f.iconOut||_conf.default.icon.zoomOut:f.iconIn||_conf.default.icon.zoomIn})]):null,d||v?s("div",{class:["vxe-custom--wrapper",{"is--active":r.visible}],ref:"customWrapper"},[s("div",{class:"vxe-tools--operate-btn vxe-tools--operate-custom-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.custom")},on:x},[s("i",{class:m.icon||_conf.default.icon.custom})]),s("div",{class:"vxe-custom--option-wrapper"},[s("div",{class:"vxe-custom--header"},[s("li",{class:["vxe-custom--option",{"is--checked":r.isAll,"is--indeterminate":r.isIndeterminate}],attrs:{title:_conf.default.i18n("vxe.table.allTitle")},on:{click:this.allCustomEvent}},[s("span",{class:"vxe-checkbox--icon vxe-checkbox--checked-icon"}),s("span",{class:"vxe-checkbox--icon vxe-checkbox--unchecked-icon"}),s("span",{class:"vxe-checkbox--icon vxe-checkbox--indeterminate-icon"}),s("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])]),s("ul",{class:"vxe-custom--body",on:g},p.map(function(t){var e=t.getTitle(),o=t.getKey(),i=!!m.checkMethod&&!m.checkMethod({column:t});return e&&o?s("li",{class:["vxe-custom--option",{"is--checked":t.visible,"is--disabled":i}],attrs:{title:e},on:{click:function(){i||(t.visible=!t.visible,(d||v)&&m.immediate&&n.handleCustoms(),n.checkCustomStatus())}}},[s("span",{class:"vxe-checkbox--icon vxe-checkbox--checked-icon"}),s("span",{class:"vxe-checkbox--icon vxe-checkbox--unchecked-icon"}),s("span",{class:"vxe-checkbox--icon vxe-checkbox--indeterminate-icon"}),s("span",{class:"vxe-checkbox--label"},e)]):null})),!1===m.isFooter?null:s("div",{class:"vxe-custom--footer"},[s("button",{class:"btn--confirm",on:{click:this.confirmCustomEvent}},_conf.default.i18n("vxe.toolbar.customConfirm")),s("button",{class:"btn--reset",on:{click:this.resetCustomEvent}},_conf.default.i18n("vxe.toolbar.customRestore"))])])]):null])])},methods:{updateConf:function(){var t=this.$parent.$children,o=t.indexOf(this);this.$xetable=_xeUtils.default.find(t,function(t,e){return t&&t.refreshColumn&&o<e&&"vxe-table"===t.$vnode.componentOptions.tag})},openCustom:function(){this.customStore.visible=!0,this.checkCustomStatus()},closeCustom:function(){var t=this.custom,e=this.setting,o=this.customStore;o.visible&&(o.visible=!1,!t&&!e||o.immediate||this.handleCustoms())},restoreCustomStorage:function(){var t=this.$xegrid,e=this.$xetable,o=this.id,i=this.resizable,s=this.custom,n=this.setting,r=this.resizableOpts,l=this.customOpts;if(i||s||n){var a={},c=t||e,u=c.getTableColumn().fullColumn;if(r.storage){var h=this.getStorageMap(r.storageKey)[o];h&&_xeUtils.default.each(h,function(t,e){a[e]={field:e,resizeWidth:t}})}if(l.storage){var f=this.getStorageMap(l.storageKey)[o];if(f){var d=f.split("|"),v=d[0]?d[0].split(","):[],m=d[1]?d[1].split(","):[];v.forEach(function(t){a[t]?a[t].visible=!1:a[t]={field:t,visible:!1}}),m.forEach(function(t){a[t]?a[t].visible=!0:a[t]={field:t,visible:!0}})}}var b={};u.forEach(function(t){var e=t.getKey();e&&(b[e]=t)}),_xeUtils.default.each(a,function(t,e){var o=t.visible,i=t.resizeWidth,s=b[e];s&&(_xeUtils.default.isNumber(i)&&(s.resizeWidth=i),_xeUtils.default.isBoolean(o)&&(s.visible=o))}),c.refreshColumn(),this.tableFullColumn=u}},updateColumns:function(t){this.tableFullColumn=t},getStorageMap:function(t){var e=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(t));return o&&o._v===e?o:{_v:e}},saveColumnVisible:function(){var t=this.id,e=this.tableFullColumn,o=this.customOpts,i=o.checkMethod,s=o.storage,n=o.storageKey;if(s){var r=this.getStorageMap(n),l=[],a=[];e.forEach(function(t){if(!i||i({column:t}))if(!t.visible&&t.defaultVisible){var e=t.getKey();e&&l.push(e)}else if(t.visible&&!t.defaultVisible){var o=t.getKey();o&&a.push(o)}}),r[t]=[l.join(",")].concat(a.length?[a.join(",")]:[]).join("|")||void 0,localStorage.setItem(n,_xeUtils.default.toJSONString(r))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,o=this.tableFullColumn,i=this.resizableOpts;if(i.storage){var s,n=this.getStorageMap(i.storageKey);t||(s=_xeUtils.default.isPlainObject(n[e])?n[e]:{},o.forEach(function(t){if(t.resizeWidth){var e=t.getKey();e&&(s[e]=t.renderWidth)}})),n[e]=_xeUtils.default.isEmpty(s)?void 0:s,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(n))}return this.$nextTick()},hideColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),t.visible=!1,this.handleCustoms()},showColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),t.visible=!0,this.handleCustoms()},resetCustoms:function(){return this.handleCustoms()},resetResizable:function(){this.updateResizable(this)},confirmCustomEvent:function(t){this.closeCustom(),this.emitCustomEvent("confirm",t)},customOpenEvent:function(t){this.customStore.visible||(this.openCustom(),this.emitCustomEvent("open",t))},customColseEvent:function(t){this.customStore.visible&&(this.closeCustom(),this.emitCustomEvent("close",t))},resetCustomEvent:function(t){var e=this.customOpts.checkMethod;this.tableFullColumn.forEach(function(t){e&&!e({column:t})||(t.visible=t.defaultVisible),t.resizeWidth=0}),this.resetCustoms(),this.resetResizable(),this.closeCustom(),this.emitCustomEvent("reset",t)},emitCustomEvent:function(t,e){var o=this.$xetable,i={type:t,$table:o,$grid:this.$xegrid,$event:e};o.$emit("custom",i,e)},updateResizable:function(t){var e=this.$xegrid||this.$xetable;return this.saveColumnWidth(t),e.analyColumnWidth(),e.recalculate(!0)},handleCustoms:function(){return(this.$xegrid||this.$xetable).refreshColumn(),this.saveColumnVisible()},checkCustomStatus:function(){var e=this.customOpts.checkMethod,t=this.tableFullColumn;this.customStore.isAll=t.every(function(t){return!!e&&!e({column:t})||t.visible}),this.customStore.isIndeterminate=!this.customStore.isAll&&t.some(function(t){return(!e||e({column:t}))&&t.visible})},allCustomEvent:function(){var e=this.customOpts.checkMethod,o=!this.customStore.isAll;this.tableFullColumn.forEach(function(t){e&&!e({column:t})||(t.visible=o)}),this.customStore.isAll=o,this.checkCustomStatus()},handleGlobalKeydownEvent:function(t){27===t.keyCode&&this.$xegrid&&this.$xegrid.isMaximized()&&this.zoomOpts&&!1!==this.zoomOpts.escRestore&&this.triggerZoomEvent(t)},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.customColseEvent(t)},handleGlobalBlurEvent:function(t){this.customColseEvent(t)},handleClickSettingEvent:function(t){this.customStore.visible?this.customColseEvent(t):this.customOpenEvent(t)},handleMouseenterSettingEvent:function(t){this.customStore.activeBtn=!0,this.customOpenEvent(t)},handleMouseleaveSettingEvent:function(t){var e=this,o=this.customStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.customColseEvent(t)},300)},handleWrapperMouseenterEvent:function(t){this.customStore.activeWrapper=!0,this.customOpenEvent(t)},handleWrapperMouseleaveEvent:function(t){var e=this,o=this.customStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.customColseEvent(t)},300)},refreshEvent:function(){var t=this,e=this.$xegrid,o=this.refreshOpts;if(!this.isRefresh)if(o.query){this.isRefresh=!0;var i=o.query();try{i.catch(function(t){return t}).then(function(){t.isRefresh=!1})}catch(t){_tools.UtilTools.error("vxe.error.typeErr",["refresh.query","Promise",_typeof(i)])}}else e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1}))},btnEvent:function(t,e){var o=this.$xegrid,i=this.$xetable,s=e.code;if(s)if(o)o.triggerToolbarBtnEvent(e,t);else{var n=_vXETable.default.commands.get(s),r={code:s,button:e,$xegrid:o,$table:i,$event:t};n&&n.call(this,r,t),_tools.UtilTools.emitEvent(this,"button-click",[r,t])}},importEvent:function(){var t=this.$xegrid||this.$xetable;if(!t)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));t.openImport(this.importOpts)},exportEvent:function(){var t=this.$xegrid||this.$xetable;if(!t)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));t.openExport(this.exportOpts)},triggerZoomEvent:function(t){var e=this.$xegrid;e.zoom(),e.$emit("zoom",{$grid:e,maximize:e.isMaximized(),type:e.isMaximized()?"max":"revert",$event:t},t)}}};exports.default=_default2;